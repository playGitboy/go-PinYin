package main

import (
	"bufio"
	"fmt"
	"io"
	"os"
	"sort"
	"strings"

	"gitee.com/xuender/oils/base"
)

func main() {
	file := base.Panic1(os.Open("data/dict.txt"))
	reader := bufio.NewReader(file)
	pySet := base.NewSet[string]()
	pyMap := base.NewMap[rune, string]()

	defer file.Close()

	for {
		line, _, err := reader.ReadLine()
		if err == io.EOF {
			break
		}

		str := string(line)
		runes := []rune(str)
		py := string(runes[1:])
		pyMap[runes[0]] = py
		pySet.Add(strings.Split(py, ",")...)
	}

	gofile := base.Panic1(os.Create("dict_gen.go"))
	defer gofile.Close()

	pySlice := base.NewSlice(pySet.Slice()...)
	sort.Sort(pySlice)

	_, _ = gofile.WriteString("// Code generated by dict2data. DO NOT EDIT.\n")
	_, _ = gofile.WriteString("package gopy\n\n")
	_, _ = gofile.WriteString("var tones = []string{")

	for index, pinyin := range pySlice {
		if index%10 == 0 {
			_, _ = gofile.WriteString("\n\t")
		}

		_, _ = gofile.WriteString("\"")
		_, _ = gofile.WriteString(pinyin)
		_, _ = gofile.WriteString("\", ")
	}

	_, _ = gofile.WriteString("\n}")
	tones := base.NewMap[rune, []int]()

	for key, value := range pyMap {
		values := strings.Split(value, ",")
		tones[key] = make([]int, len(values))

		for sub, pyStr := range values {
			tones[key][sub] = pySlice.Index(pyStr)
		}
	}

	_, _ = gofile.WriteString("\n\nvar data = Dict(map[rune][]int16{\n")

	for k, v := range tones {
		s := base.NewSlice(v...)
		_, _ = gofile.WriteString(fmt.Sprintf("\t0x%x:{%s},\n", k, s.Join(",")))
	}

	_, _ = gofile.WriteString("})\n")
}
