package main

import (
	"bufio"
	"fmt"
	"io"
	"os"
	"sort"
	"strings"

	"gitee.com/xuender/oils/base"
)

func main() {
	file := base.Panic1(os.Open("data/dict.txt"))
	defer file.Close()

	reader := bufio.NewReader(file)
	pySet := base.NewSet[string]()
	pyMap := base.NewMap[rune, string]()

	for {
		line, _, err := reader.ReadLine()
		if err == io.EOF {
			break
		}

		str := string(line)
		runes := []rune(str)
		py := string(runes[1:])
		pyMap[runes[0]] = py
		pySet.Add(strings.Split(py, ",")...)
	}

	pySlice := base.NewSlice(pySet.Slice()...)
	sort.Sort(pySlice)
	gofile := base.Panic1(os.Create("dict_gen.go"))
	defer gofile.Close()

	gofile.WriteString("// Code generated by dict2data. DO NOT EDIT.\n")
	gofile.WriteString("package gopy\n\n")
	gofile.WriteString("var tones = []string{")
	for i, py := range pySlice {
		if i%10 == 0 {
			gofile.WriteString("\n\t")
		}

		gofile.WriteString("\"")
		gofile.WriteString(py)
		gofile.WriteString("\", ")
	}

	gofile.WriteString("\n}")
	tones := base.NewMap[rune, []int]()
	for k, v := range pyMap {
		vs := strings.Split(v, ",")
		tones[k] = make([]int, len(vs))
		for i, py := range vs {
			tones[k][i] = pySlice.Index(py)
		}
	}

	// var data = Dict(map[rune][]int{})
	gofile.WriteString("\n\nvar data = Dict(map[rune][]int16{\n")
	for k, v := range tones {
		s := base.NewSlice(v...)
		gofile.WriteString(fmt.Sprintf("\t0x%x:{%s},\n", k, s.Join(",")))
	}
	gofile.WriteString("})\n")
}
